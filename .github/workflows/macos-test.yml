name: macOS build test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    #- name: Install Qt
    #  uses: jurplel/install-qt-action@v4
    #  with:
    #   version: '5.15.2'
    #   modules: 'qtnetworkauth'
    #   archives: 'qtbase qtsvg'

    - name: install deps
      run: brew install cmake ninja pkgconf cppunit utf8cpp qt@5

    - name: Gstreamer
      run: |
        curl -sLO https://gstreamer.freedesktop.org/data/pkg/osx/1.20.7/gstreamer-1.0-1.20.7-universal.pkg
        curl -sLO https://gstreamer.freedesktop.org/data/pkg/osx/1.20.7/gstreamer-1.0-devel-1.20.7-universal.pkg
        sudo installer -package gstreamer-1.0-1.20.7-universal.pkg -target /
        sudo installer -package gstreamer-1.0-devel-1.20.7-universal.pkg -target /
        echo "pkconfigdirs"
        find /Library/Frameworks/GStreamer.framework/Versions/Current/ -type d -name 'pkgconfig'
        # sudo cp -R /Library/Frameworks/GStreamer.framework /Library/Frameworks/GStreamer.framework.dist

    - name: Build
      env:
        LDFLAGS: "-L/opt/homebrew/opt/qt@5/lib"
        CPPFLAGS: "-I/opt/homebrew/opt/qt@5/include"
        PKG_CONFIG_PATH: "/opt/homebrew/opt/qt@5/lib/pkgconfig:/Library/Frameworks/GStreamer.framework/Versions/Current/lib/pkgconfig:/Library/Frameworks/GStreamer.framework/Versions/Current/lib/gstreamer-1.0/pkgconfig"
        QT_DIR: "/opt/homebrew/opt/qt@5/"
        Qt5_DIR: "/opt/homebrew/opt/qt@5/"
      run: |
        echo $PKG_CONFIG_PATH
        pkg-config --cflags --libs gstreamer-1.0 gstreamer-video-1.0 gstreamer-audio-1.0 gstreamer-tag-1.0
        cmake -DSPDLOG_USE_BUNDLED=true . -B build -G Ninja
        ninja -C build
