name: macOS build test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: install deps
      run: brew install cmake ninja pkgconf cppunit utf8cpp qt@5 gstreamer

    - name: Build
      env:
        LDFLAGS: "-L/opt/homebrew/opt/qt@5/lib"
        CPPFLAGS: "-I/opt/homebrew/opt/qt@5/include"
        PKG_CONFIG_PATH: "/opt/homebrew/opt/qt@5/lib/pkgconfig"
        QT_DIR: "/opt/homebrew/opt/qt@5/"
        Qt5_DIR: "/opt/homebrew/opt/qt@5/"
      run: |
        cmake -DSPDLOG_USE_BUNDLED=true . -B build -G Ninja
        ninja -C build
    - name: Upload app
      uses: actions/upload-artifact@v4
      with:
        path: build/openkj.app
        name: openkj.app
