name: macOS build test

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
       version: '5.15.2'
       modules: 'qtnetworkauth'
       archives: 'qtbase qtsvg'

    - name: install deps
      run: brew install cmake cppunit utf8cpp ninja

    - name: Download Gstreamer
      run: |
        curl -sLO https://gstreamer.freedesktop.org/data/pkg/osx/1.27.1/gstreamer-1.0-1.27.1-universal.pkg
        curl -sLO https://gstreamer.freedesktop.org/data/pkg/osx/1.27.1/gstreamer-1.0-devel-1.27.1-universal.pkg
        curl -sLO https://taglib.org/releases/taglib-1.13.1.tar.gz

    - name: taglib
      run: |
        tar xzf taglib-1.13.1.tar.gz
        cd taglib-1.13.1
        cmake -B build -G Ninja -DCMAKE_POLICY_VERSION_MINIMUM=3.5 -DBUILD_TESTING=OFF
        cmake --build build
        sudo cmake --install build

    - name: Install GST
      run: |
        sudo installer -package gstreamer-1.0-1.27.1-universal.pkg -target /
        sudo installer -package gstreamer-1.0-devel-1.27.1-universal.pkg -target /
        sudo cp -R /Library/Frameworks/GStreamer.framework /Library/Frameworks/GStreamer.framework.dist

    - name: Build
      run: |
        cmake -DSPDLOG_USE_BUNDLED=true . -B build -G Ninja
        ninja -C build
